# =============================================================================
# Deploy apps/app to Azure Container Apps
# Triggers on push to main when apps/app or packages change
# =============================================================================

name: Deploy App

on:
  push:
    branches:
      - main
    paths:
      - "apps/app/**"
      - "packages/**"

env:
  IMAGE_NAME: app

jobs:
  # ---------------------------------------------------------------------------
  # Detect: Verify deployment is needed (path filters already handle this,
  # but this job provides explicit confirmation in logs)
  # ---------------------------------------------------------------------------
  detect:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check for relevant changes
        id: check
        run: |
          # Get changed files between HEAD and previous commit
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          echo "Changed files:"
          echo "$CHANGED_FILES"

          # Check if any relevant paths changed
          if echo "$CHANGED_FILES" | grep -qE '^(apps/app/|packages/)'; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "Deployment required: relevant paths changed"
          else
            echo "should_deploy=false" >> $GITHUB_OUTPUT
            echo "No deployment required: no relevant paths changed"
          fi

  # ---------------------------------------------------------------------------
  # Build: Build and push Docker image to ACR
  # ---------------------------------------------------------------------------
  build:
    name: Build & Push Image
    runs-on: ubuntu-latest
    needs: detect
    if: needs.detect.outputs.should_deploy == 'true'
    outputs:
      image_tag: ${{ steps.meta.outputs.image_tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set image metadata
        id: meta
        run: |
          IMAGE_TAG="${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
          echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "Image will be tagged as: $IMAGE_TAG"

      - name: Log in to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Log in to ACR
        run: |
          az acr login --name ${{ secrets.ACR_NAME }}

      - name: Build Docker image
        run: |
          docker build \
            -f apps/app/Dockerfile \
            -t ${{ steps.meta.outputs.image_tag }} \
            .

      - name: Push Docker image to ACR
        run: |
          docker push ${{ steps.meta.outputs.image_tag }}

  # ---------------------------------------------------------------------------
  # Deploy: Update Azure Container App with new image
  # ---------------------------------------------------------------------------
  deploy:
    name: Deploy to Container Apps
    runs-on: ubuntu-latest
    needs: [detect, build]
    if: needs.detect.outputs.should_deploy == 'true'
    steps:
      - name: Log in to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy to Azure Container Apps
        run: |
          az containerapp update \
            --name ${{ secrets.AZURE_CONTAINER_APP_NAME }} \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --image ${{ needs.build.outputs.image_tag }}

      - name: Deployment summary
        run: |
          echo "Deployment complete"
          echo "Image: ${{ needs.build.outputs.image_tag }}"
          echo "Container App: ${{ secrets.AZURE_CONTAINER_APP_NAME }}"
          echo "Resource Group: ${{ secrets.AZURE_RESOURCE_GROUP }}"
